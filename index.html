<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vexu Rooms - Full Supabase Chat</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom styles for the light green accent */
        .vexu-green { background-color: #10b981; } /* emerald-500 */
        .vexu-green-text { color: #10b981; }
        .vexu-green-border { border-color: #10b981; }
        
        /* Message container fixed height and scroll */
        #messages-container {
            height: 100%;
            max-height: calc(100vh - 22rem); /* Adjusted height for full chat view */
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* For bottom-up scrolling */
        }
        
        /* Room list scroll container */
        #room-list {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Custom scrollbar for aesthetic, optional */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 font-sans">

    <!-- 1. HEADER / NAVIGATION BAR -->
    <nav class="bg-gray-800 shadow-xl sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo/Branding -->
                <div class="flex-shrink-0 flex items-center">
                    <svg class="h-8 w-8 vexu-green-text" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6-6h6l-3-6m12 6h-6l3-6M12 21a9 9 0 000-18 9 9 0 000 18z" />
                    </svg>
                    <span class="text-2xl font-extrabold ml-2">Vexu Rooms</span>
                </div>

                <!-- Account Button & Profile Status -->
                <div class="flex items-center space-x-4">
                    <div id="user-profile-display" class="hidden sm:block text-sm text-gray-400">
                        <span class="font-semibold text-gray-300">Profile:</span>
                        <span id="current-username" class="italic text-emerald-400">Loading...</span>
                    </div>
                    <button id="account-btn"
                            class="bg-gray-900 text-gray-100 hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out shadow-lg">
                        <span id="account-button-text">Account</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT AREA -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
        <!-- Welcome View (Visible when logged OUT) -->
        <section id="welcome-view" class="text-center py-20">
            <h1 class="text-4xl font-bold vexu-green-text">Welcome to Vexu Rooms</h1>
            <p class="mt-4 text-lg text-gray-400">Log in to manage your profile and join the chat rooms.</p>
        </section>

        <!-- Chat View (Visible when logged IN) -->
        <section id="chat-view" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 h-full">
                
                <!-- Room List Sidebar (Col 1) -->
                <div class="md:col-span-1 bg-gray-800 rounded-xl p-4 shadow-2xl">
                    <h2 class="text-xl font-bold vexu-green-text mb-4 border-b border-gray-700 pb-2">Rooms</h2>
                    
                    <!-- Create Room Button -->
                    <button id="create-room-btn" class="w-full bg-emerald-700 hover:bg-emerald-600 text-white font-medium py-2 rounded-lg mb-4 transition duration-150">
                        + New Room
                    </button>

                    <!-- Room List -->
                    <div id="room-list" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading rooms...</p>
                    </div>
                </div>

                <!-- Chat Area (Cols 2-4) -->
                <div class="md:col-span-3 flex flex-col bg-gray-800 rounded-xl p-6 shadow-2xl">
                    
                    <h2 id="room-title" class="text-2xl font-extrabold text-gray-200 mb-4 pb-2 border-b border-gray-700">Select a Room to Start Chatting</h2>
                    
                    <!-- Messages Container (The scrollable chat area) -->
                    <div id="messages-container" class="flex-grow bg-gray-900 rounded-lg p-4 overflow-y-auto mb-4">
                        <div id="messages-list" class="space-y-3">
                            <p class="text-center text-gray-500 italic mt-8">No room selected. Choose a room on the left.</p>
                        </div>
                    </div>

                    <!-- Message Input Form -->
                    <form id="message-form" class="flex gap-4">
                        <input type="text" id="message-input" placeholder="Type your message..." required disabled
                               class="flex-grow px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-gray-100 placeholder-gray-400 disabled:opacity-50">
                        <button type="submit" id="send-btn" disabled
                                class="vexu-green text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-emerald-600 transition duration-150 ease-in-out shadow-lg disabled:opacity-50">
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- 2. MODALS (AUTH, PROFILE, CREATE ROOM) -->
    <div id="global-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 hidden" 
         onclick="if(event.target.id === 'global-modal') closeModal()">
        
        <!-- Modal Content Container -->
        <div id="modal-content-container" class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 border vexu-green-border border-2 transform scale-100 transition-all duration-300">
            <!-- Content will be injected here -->
        </div>
    </div>
    
    <!-- 3. JAVASCRIPT LOGIC (SUPABASE) -->
    <script>
        // --- CONFIGURATION ---
        // Supabase Project URL
        const SUPABASE_URL = 'https://uvgnsbikukbxdujfkrpw.supabase.co'; 
        // Supabase Public API Key
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2Z25zYmlrdWtieGR1amZrcnB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MjA4MDYsImV4cCI6MjA3OTQ5NjgwNn0.Ss7BeFNi0I6WgAYOU1vqo2IQn1KeQf9jk56sTgAnkNc';
        
        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL STATE ---
        let currentUserId = null;
        let currentUsername = 'Guest';
        let currentRoomId = null;
        let activeChannel = null; // Supabase Realtime Channel
        let roomsCache = [];
        let profilesCache = {};

        // --- UI Elements ---
        const globalModal = document.getElementById('global-modal');
        const modalContentContainer = document.getElementById('modal-content-container');
        const accountBtn = document.getElementById('account-btn');
        const accountButtonText = document.getElementById('account-button-text');
        const welcomeView = document.getElementById('welcome-view');
        const chatView = document.getElementById('chat-view');
        const userProfileDisplay = document.getElementById('user-profile-display');
        const currentUsernameEl = document.getElementById('current-username');
        const roomListEl = document.getElementById('room-list');
        const roomTitleEl = document.getElementById('room-title');
        const messagesListEl = document.getElementById('messages-list');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const createRoomBtn = document.getElementById('create-room-btn');


        // --- MODAL AND UI HELPERS ---

        function showMessageBox(title, message, isError = false) {
            let msgBox = document.getElementById('custom-message-box');
            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'custom-message-box';
                msgBox.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0';
                document.body.appendChild(msgBox);
            }
            msgBox.className = `fixed top-4 right-4 ${isError ? 'bg-red-700' : 'vexu-green'} text-white p-4 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-100`;
            msgBox.innerHTML = `<p class="font-bold">${title}</p><p class="text-sm">${message}</p>`;

            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
            }, 5000);
        }
        
        function openModal(contentHtml) {
            modalContentContainer.innerHTML = contentHtml;
            globalModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeModal() {
            globalModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            modalContentContainer.innerHTML = '';
        }

        // --- AUTH/PROFILE HANDLERS ---

        function renderAuthModal(isSignUpMode = false) {
            const mode = isSignUpMode ? 'Sign Up' : 'Log In';
            const switchText = isSignUpMode ? 'Already have an account? Log In' : 'Need an account? Sign Up';

            const html = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-3xl font-bold vexu-green-text">${mode}</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition duration-150">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div id="modal-error-message" class="text-red-400 mb-4 text-sm font-medium"></div>

                <form id="auth-form" class="space-y-4" data-mode="${mode}">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300">Email Address</label>
                        <input type="email" id="email" required class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-gray-100" placeholder="you@vexu.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="password" required minlength="6" class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-gray-100" placeholder="min 6 characters">
                    </div>
                    <button type="submit" class="w-full vexu-green text-gray-900 font-bold py-3 rounded-lg hover:bg-emerald-600 transition duration-150 ease-in-out shadow-lg">${mode}</button>
                </form>

                <div id="switch-link" class="mt-6 text-center text-sm text-gray-400">
                    <span class="font-semibold cursor-pointer hover:underline" onclick="renderAuthModal(!${isSignUpMode})">${switchText}</span>
                </div>
            `;
            openModal(html);
            document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit);
        }

        async function handleAuthSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const email = form.querySelector('#email').value;
            const password = form.querySelector('#password').value;
            const errorMessageDiv = document.getElementById('modal-error-message');
            const mode = form.dataset.mode;
            errorMessageDiv.textContent = ''; 

            try {
                let response;
                if (mode === 'Sign Up') {
                    response = await supabaseClient.auth.signUp({ email, password });
                    
                    if (response.error) throw response.error;

                    if (response.data.user) {
                        showMessageBox('Success', 'Sign Up Successful! Please check your email to confirm your account.');
                        renderAuthModal(false); // Switch to login after signup
                    }
                } else {
                    response = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (response.error) throw response.error;
                }
            } catch (error) {
                console.error('Auth Error:', error);
                errorMessageDiv.textContent = error.message || 'An unknown error occurred during authentication.';
            }
        }

        function renderProfileModal() {
            const html = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-3xl font-bold vexu-green-text">Update Profile</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition duration-150">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="modal-error-message" class="text-red-400 mb-4 text-sm font-medium"></div>

                <p class="text-sm text-gray-400 mb-4">Your User ID (for reference): <span class="break-all text-gray-300">${currentUserId}</span></p>

                <form id="profile-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="username" required minlength="3" 
                               value="${currentUsername}"
                               class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-gray-100" placeholder="Your unique name">
                    </div>
                    <button type="submit" class="w-full vexu-green text-gray-900 font-bold py-3 rounded-lg hover:bg-emerald-600 transition duration-150 ease-in-out shadow-lg">
                        Update Username
                    </button>
                </form>
            `;
            openModal(html);
            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const newUsername = document.getElementById('username').value.trim();
            const errorMessageDiv = document.getElementById('modal-error-message');
            errorMessageDiv.textContent = '';

            if (newUsername.length < 3) {
                errorMessageDiv.textContent = 'Username must be at least 3 characters.';
                return;
            }

            try {
                // Update the profile table for the current user
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ username: newUsername, updated_at: new Date().toISOString() })
                    .eq('id', currentUserId);

                if (error) {
                    if (error.code === '23505') { // Unique constraint violation
                        errorMessageDiv.textContent = 'That username is already taken.';
                    } else {
                        throw error;
                    }
                } else {
                    currentUsername = newUsername;
                    currentUsernameEl.textContent = newUsername;
                    profilesCache[currentUserId] = newUsername; // Update cache
                    showMessageBox('Success', 'Username updated successfully!');
                    closeModal();
                }
            } catch (error) {
                console.error('Profile Update Error:', error);
                errorMessageDiv.textContent = error.message || 'Failed to update profile.';
            }
        }

        // --- ROOM HANDLERS ---

        function renderCreateRoomModal() {
            const html = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-3xl font-bold vexu-green-text">Create New Room</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition duration-150">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="modal-error-message" class="text-red-400 mb-4 text-sm font-medium"></div>

                <form id="create-room-form" class="space-y-4">
                    <div>
                        <label for="room-name" class="block text-sm font-medium text-gray-300">Room Name</label>
                        <input type="text" id="room-name" required minlength="3" 
                               class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-gray-100" placeholder="e.g., General Chat">
                    </div>
                    <button type="submit" class="w-full vexu-green text-gray-900 font-bold py-3 rounded-lg hover:bg-emerald-600 transition duration-150 ease-in-out shadow-lg">
                        Create Room
                    </button>
                </form>
            `;
            openModal(html);
            document.getElementById('create-room-form').addEventListener('submit', handleCreateRoom);
        }

        async function handleCreateRoom(e) {
            e.preventDefault();
            const roomName = document.getElementById('room-name').value.trim();
            const errorMessageDiv = document.getElementById('modal-error-message');
            errorMessageDiv.textContent = '';

            try {
                const { data: roomData, error: roomError } = await supabaseClient
                    .from('rooms')
                    .insert([{ name: roomName, created_by: currentUserId }])
                    .select()
                    .single();

                if (roomError) throw roomError;

                // Automatically join the room after creation
                await joinRoom(roomData.id, roomData.name, true);

                showMessageBox('Success', `Room "${roomName}" created and joined!`);
                closeModal();
            } catch (error) {
                console.error('Create Room Error:', error);
                errorMessageDiv.textContent = error.message || 'Failed to create room.';
            }
        }

        async function fetchRooms() {
            roomListEl.innerHTML = '<p class="text-gray-500 text-sm p-2">Loading rooms...</p>';
            
            const { data, error } = await supabaseClient
                .from('rooms')
                .select('id, name');

            if (error) {
                console.error('Error fetching rooms:', error);
                roomListEl.innerHTML = `<p class="text-red-400 text-sm p-2">Error: ${error.message}</p>`;
                return;
            }

            roomsCache = data;
            renderRoomList();

            // If a room is already selected, re-select it to maintain state
            if (currentRoomId) {
                const room = roomsCache.find(r => r.id === currentRoomId);
                if (room) {
                    await joinRoom(room.id, room.name);
                }
            }
        }

        function renderRoomList() {
            roomListEl.innerHTML = '';
            if (roomsCache.length === 0) {
                roomListEl.innerHTML = '<p class="text-gray-500 text-sm p-2">No rooms found. Create one!</p>';
                return;
            }

            roomsCache.forEach(room => {
                const isSelected = room.id === currentRoomId;
                const roomItem = document.createElement('button');
                roomItem.className = `w-full text-left p-3 rounded-lg font-medium transition duration-150 hover:bg-gray-700 focus:outline-none ${isSelected ? 'vexu-green text-gray-900 shadow-md' : 'bg-gray-700 text-gray-200'}`;
                roomItem.textContent = room.name;
                roomItem.onclick = () => joinRoom(room.id, room.name);
                roomListEl.appendChild(roomItem);
            });
        }
        
        async function joinRoom(roomId, roomName, isNew = false) {
            if (!currentUserId) {
                showMessageBox('Error', 'Please log in to join a room.', true);
                return;
            }

            // 1. Attempt to insert participant record (if it doesn't exist, Supabase handles the unique constraint)
            try {
                const { error: joinError } = await supabaseClient
                    .from('room_participants')
                    .insert([{ user_id: currentUserId, room_id: roomId }]);

                if (joinError && joinError.code !== '23505' && !isNew) { // Ignore duplicate key error '23505' unless creating a new room failed
                    throw joinError;
                }
            } catch (error) {
                console.error('Error joining room:', error);
                showMessageBox('Error', 'Failed to join room. Check RLS policies.', true);
                return;
            }
            
            // 2. Update state and UI
            currentRoomId = roomId;
            roomTitleEl.textContent = roomName;
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();

            // 3. Re-render room list to highlight the selected room
            renderRoomList();

            // 4. Load messages and set up real-time listener
            await fetchMessages(roomId);
            setupRealtimeListener(roomId);
        }
        
        // --- MESSAGING AND REAL-TIME ---

        async function fetchProfiles(userIds) {
            // Fetch only profiles not already in the cache
            const idsToFetch = userIds.filter(id => !profilesCache[id]);
            if (idsToFetch.length === 0) return;

            const { data, error } = await supabaseClient
                .from('profiles')
                .select('id, username')
                .in('id', idsToFetch);

            if (error) {
                console.error('Error fetching profiles:', error);
                return;
            }

            data.forEach(profile => {
                profilesCache[profile.id] = profile.username;
            });
        }

        async function fetchMessages(roomId) {
            messagesListEl.innerHTML = '<p class="text-center text-gray-500 italic mt-8">Loading messages...</p>';
            
            // Join chat_messages with profiles to get the username
            const { data, error } = await supabaseClient
                .from('chat_messages')
                .select(`
                    id,
                    user_id,
                    message_text,
                    timestamp,
                    profiles (username)
                `)
                .eq('room_id', roomId)
                .order('timestamp', { ascending: false })
                .limit(50); 

            if (error) {
                console.error("Error fetching messages:", error);
                messagesListEl.innerHTML = `<p class="text-center text-red-400 italic mt-8">Error loading messages: ${error.message}</p>`;
                return;
            }

            renderMessages(data.reverse()); // Reverse to get chronological order for column-reverse container
        }

        function renderMessages(messages) {
            messagesListEl.innerHTML = '';
            const messagesContainer = document.getElementById('messages-container');
            const shouldScroll = messagesContainer.scrollTop >= (messagesContainer.scrollHeight - messagesContainer.clientHeight - 50);

            if (messages.length === 0) {
                messagesListEl.innerHTML = '<p class="text-center text-gray-500 italic mt-8">Start the conversation!</p>';
                return;
            }

            messages.forEach(msg => {
                const senderId = msg.user_id;
                const senderUsername = msg.profiles ? msg.profiles.username : 'Unknown User';
                const isMine = senderId === currentUserId;
                const date = new Date(msg.timestamp);
                const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const messageDiv = document.createElement('div');
                
                messageDiv.className = `flex my-2 ${isMine ? 'justify-end' : 'justify-start'}`;
                
                messageDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md ${isMine ? 'vexu-green text-gray-900 rounded-br-none' : 'bg-gray-700 text-gray-100 rounded-tl-none'}">
                        <p class="text-xs font-semibold ${isMine ? 'text-gray-700' : 'text-emerald-400'} mb-1">${isMine ? 'You' : senderUsername}</p>
                        <p class="break-words">${msg.message_text}</p>
                        <span class="block text-right text-xs mt-1 ${isMine ? 'text-gray-700' : 'text-gray-400'}">${time}</span>
                    </div>
                `;
                
                messagesListEl.appendChild(messageDiv);
            });

            // Auto-scroll to bottom if the user was near the bottom before rendering
            if (shouldScroll) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        function setupRealtimeListener(roomId) {
            // Remove previous listener if it exists
            if (activeChannel) {
                supabaseClient.removeChannel(activeChannel);
            }
            
            // Create a new channel specific to the current room
            activeChannel = supabaseClient
                .channel(`room:${roomId}`)
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'chat_messages',
                    filter: `room_id=eq.${roomId}`
                }, async (payload) => {
                    // Fetch the full message data including the profile
                    const { data: fullMessageData, error } = await supabaseClient
                        .from('chat_messages')
                        .select(`
                            id,
                            user_id,
                            message_text,
                            timestamp,
                            profiles (username)
                        `)
                        .eq('id', payload.new.id)
                        .single();

                    if (error) {
                        console.error('Error fetching new message details:', error);
                        return;
                    }
                    
                    renderMessages([fullMessageData]); // Append and render the new message
                })
                .subscribe();
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (!currentUserId || !currentRoomId) {
                showMessageBox("Error", "Please log in and select a room.", true);
                return;
            }

            if (text) {
                const { error } = await supabaseClient
                    .from('chat_messages')
                    .insert({
                        user_id: currentUserId,
                        room_id: currentRoomId,
                        message_text: text
                    });

                if (error) {
                    console.error("Error sending message:", error);
                    showMessageBox("Error", `Failed to send message: ${error.message}. Check RLS Policy 2 on chat_messages.`, true);
                } else {
                    messageInput.value = ''; // Clear input
                }
            }
        });

        // --- AUTH STATE MANAGEMENT ---

        async function getCurrentProfile(userId) {
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('username')
                .eq('id', userId)
                .single();

            if (error) {
                console.error('Error fetching profile:', error);
                return 'User ' + userId.substring(0, 8); // Fallback
            }
            return data.username;
        }

        async function updateUIForAuthState(session) {
            if (session) {
                // User is logged in
                currentUserId = session.user.id;
                currentUsername = await getCurrentProfile(currentUserId);
                
                currentUsernameEl.textContent = currentUsername;
                accountBtn.onclick = logout;
                accountButtonText.textContent = 'Log Out';

                welcomeView.classList.add('hidden');
                chatView.classList.remove('hidden');
                userProfileDisplay.classList.remove('hidden');
                
                // Fetch rooms and set up profile button action
                fetchRooms();
                accountBtn.onclick = renderProfileModal;
                accountButtonText.textContent = 'Profile';

            } else {
                // User is logged out
                currentUserId = null;
                currentUsername = 'Guest';
                currentRoomId = null;
                
                if (activeChannel) {
                    supabaseClient.removeChannel(activeChannel);
                    activeChannel = null;
                }

                currentUsernameEl.textContent = 'Logged Out';
                accountBtn.onclick = () => renderAuthModal(false);
                accountButtonText.textContent = 'Log In';

                welcomeView.classList.remove('hidden');
                chatView.classList.add('hidden');
                userProfileDisplay.classList.add('hidden');
                
                // Reset chat view
                roomTitleEl.textContent = 'Select a Room to Start Chatting';
                messagesListEl.innerHTML = '<p class="text-center text-gray-500 italic mt-8">Log in to view rooms and messages.</p>';
                messageInput.disabled = true;
                sendBtn.disabled = true;
                roomListEl.innerHTML = '<p class="text-gray-500 text-sm p-2">Log in to load rooms...</p>';
            }
        }

        async function logout() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                console.error('Logout Error:', error);
                showMessageBox('Error', 'Logout failed!', true);
            }
            // State listener handles UI update
        }

        // --- INITIALIZATION ---
        
        createRoomBtn.onclick = renderCreateRoomModal;

        // Listen for Supabase Auth state changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            updateUIForAuthState(session);
        });

        // Initial check for existing session
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            updateUIForAuthState(session);
        });
    </script>
</body>
</html>